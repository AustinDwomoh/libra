name: Job Scraper Automation

on:
  schedule:
    - cron: '0 11 * * *'  # 6 AM CT
    - cron: '0 15 * * *'  # 10 AM CT
    - cron: '0 19 * * *'  # 2 PM CT
    - cron: '0 23 * * *'  # 6 PM CT
    - cron: '0 3 * * *'   # 10 PM CT
    - cron: '0 7 * * *'   # 2 AM CT
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail

            cd /var/www/libra/
            source libra/bin/activate
            git pull origin main
            pip install -r requirements.txt --upgrade-strategy only-if-needed
            python3 /var/www/libra/azalea.py > azalea.log 2>&1

      - name: Notify Discord on failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
          -d "{\"content\": \":x: Libra job scrape failed for **${{ github.repository }}** @ **${{ github.ref_name }}**\"}" \
          ${{ secrets.DISCORD_WEBHOOK }}

      - name: Notify Discord on success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
          -d "{\"content\": \":white_check_mark: Libra job scrape completed successfully for **${{ github.repository }}** @ **${{ github.ref_name }}**\"}" \
          ${{ secrets.DISCORD_WEBHOOK }}
